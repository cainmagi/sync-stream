---
id: LineHostBuffer
title: LineHostBuffer
sidebar_label: LineHostBuffer
slug: /apis/host/LineHostBuffer
description: The web service driven line-based buffer.
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import IconExternalLink from "@theme/Icon/ExternalLink";

import vsiCheckIcon from "@iconify-icons/codicon/check";

import APITopBar, {IconObjType} from "@site/src/components/APITopBar";
import InlineIcon from "@site/src/components/InlineIcon";

<APITopBar type="class" source="host.LineHostBuffer" />

```python
hbuf = LineHostBuffer(
    api_route: str = "/sync-stream",
    endpoint: str | None = None,
    maxlen: int = 2,
)
```

The host service provider for the line-based buffer.

The rotating buffer with a maximal storage length. This buffer is the extended version of the basic `LineBuffer`. It is used in the case of multi-devices. It supports the one-host-multi-clients mode, and supports the syncholization by the web services. To learn how to use this buffer, see the [example](#example) on this page, or the [tutorial](../../guides/sync-host.mdx).

## Aliases

This class can be acquired by

```python
import syncstream


syncstream.LineHostBuffer
syncstream.host.LineHostBuffer
```

## Arguments

|  Argument   |     Type      | Required | <center>Description</center>                                                                                                   |
| :---------: | :-----------: | :------: | :----------------------------------------------------------------------------------------------------------------------------- |
| `api_route` |     `str`     |          | The route path of the api.                                                                                                     |
| `endpoint`  | `str \| None` |          | The endpoint name of the api. If set `None`, the endpoint name would be inferred from `api_route`.                             |
|  `maxlen`   |     `int`     |          | The maximal number of stored lines. This value has the same meaning of [`deque.maxlen`<IconExternalLink/>][link-deque-maxlen]. |

## Methods

### <IconObjType type="method"/> `close`

```python
hbuf.close()
```

Close the IO. This method only takes effects once. The second call will do nothing.

---

### <IconObjType type="method"/> `read_serialized`

```python
lines: tuple[str | GroupedMessage, ...] = hbuf.read_serialized(size: int | None = None)
```

Read the records (serialized).

It has the same functionalities of `read(...)`. However, all the data returned
by this method has been serialized and compatible with jsonifying.

This method should be used for providing query services.

#### Requires

| Argument |     Type      | Required | <center>Description</center>                                                                              |
| :------: | :-----------: | :------: | :-------------------------------------------------------------------------------------------------------- |
|  `size`  | `int \| None` |          | If set `None`, would return the whole storage. If set an `int` value, would return the last `size` items. |

#### Returns

| Argument |                Type                 | <center>Description</center>                                              |
| :------: | :---------------------------------: | :------------------------------------------------------------------------ |
| `lines`  | `tuple[str \| GroupedMessage, ...]` | A sequence of fetched record items. Results are sorted in the FIFO order. |

---

### <IconObjType type="method"/> `serve`

```python
hbuf.serve(api: flask.Flask)
```

Provide the service of the host buffer.

The service would be equipped as an independent thread. Each time the request
is received, the service would be triggered, and the thread-safe results would
be saved.

#### Requires

| Argument |                      Type                      |             Required              | <center>Description</center>                                                                                     |
| :------: | :--------------------------------------------: | :-------------------------------: | :--------------------------------------------------------------------------------------------------------------- |
|  `api`   | [`flask.Flask`<IconExternalLink/>][link-flask] | <InlineIcon icon={vsiCheckIcon}/> | The `Flask` object. All web services related to this `LineHostBuffer` would be registered to the `Flask` object. |

---

### <IconObjType type="method"/> `stop_all_mirrors`

```python
flag: bool = hbuf.stop_all_mirrors()
```

Send stop signals to all mirrors.

This operation is used for terminating the mirrors safely. It does not
guarantee that the processes would be closed instantly. Each time when the new
message is written by the mirrors, a check would be triggered.

If users want to use this method, please ensure that the `StopIteration` error
is catched by the process. The error would not be sent back to the buffer.

#### Returns

| Argument |  Type  | <center>Description</center>                                                                                                                   |
| :------: | :----: | :--------------------------------------------------------------------------------------------------------------------------------------------- |
|  `flag`  | `bool` | Return `True` if the stopping is successful. Return `False` if the stopping is rejected. Raise Error if there is anything wrong on the server. |

---

### <IconObjType type="method"/> `reset_states`

```python
flag: bool = hbuf.reset_states()
```

Reset the states of the buffer.

This method should be used if the buffer needs to be reused.

#### Returns

| Argument |  Type  | <center>Description</center>                                                                                                                     |
| :------: | :----: | :----------------------------------------------------------------------------------------------------------------------------------------------- |
|  `flag`  | `bool` | Return `True` if the resetting is successful. Return `False` if the resetting is rejected. Raise Error if there is anything wrong on the server. |

## Operators

### <IconObjType type="op"/> `__len__`

```python
n_buffer_items: int = len(hbuf)
```

Number of lines/items in the buffer.

## Services

Register the Flask app with this instance, the following services would be provided, where the **`bold`** arguments are required arguments.

### <IconObjType type="service"/> `<api_route>`

The basic APIs. They are used for maintaining the storage of the message items.

| Method | <center>Requires</center>                                                                                                                                                                            | <center>Response</center>                                                                                                                              | <center>Description</center>                                                                                                                                                              |
| :----: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  GET   | <ul><li>`n`: The number of messages that is required. If not set, would return the whole storage.</li></ul>                                                                                          | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li><li>`data`: A list of returned messages.</li></ul> | Get the message items. Similar to [`LineBuffer.read()`](../mproc/LineBuffer.mdx#-read).                                                                                                   |
|  POST  | <ul><li>**`type`**: The type of the message. Could be `str`, `error`, `warning`, or `close`.</li><li>`data`: A `dict` of message data from [`LineHostMirror`](../host/LineHostMirror.mdx).</li></ul> | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li></ul>                                              | Write the remote data into the storage. This method should not be used by users directly, because it is provided for the interaction with [`LineHostMirror`](../host/LineHostMirror.mdx). |
| DELETE | <center>-</center>                                                                                                                                                                                   | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li></ul>                                              | Clear the storage, but the status of the buffer is not reset by this method.                                                                                                              |

---

### <IconObjType type="service"/> `<api_route>-state`

The APIs used for maintaining the buffer status.

| Method | <center>Requires</center>                                                                                                   | <center>Response</center>                                                                                                                                  | <center>Description</center>           |
| :----: | :-------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------- |
|  GET   | <ul><li>**`state`**: The name of the state to be read.</li></ul>                                                            | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li><li>`data`: The value of the required state.</li></ul> | Get a specific state value.            |
|  POST  | <ul><li>**`state`**: The name of the state to be written.</li><li>`value`: The value used for changing the state.</li></ul> | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li></ul>                                                  | Modify a specific state value.         |
| DELETE | <center>-</center>                                                                                                          | <ul><li>`message`: The response text. If the results are valid, this value should be `success`.</li></ul>                                                  | Reset the state to the default values. |

The states are shared by different clients. Each time the clients interact with the host, they would use `GET` method to renew their states. Some states could be used for controlling the behaviors of the clients. For example, `POST` with `state=closed`, `value=true` serves the same funcionality of invoking [`LineProcBuffer.stop_all_mirrors()`](../mproc/LineProcBuffer.mdx#-stop_all_mirrors).

## Example

### <IconObjType type="term"/> Synchronize messages by web services

<Tabs
  defaultValue="codes"
  values={[
    { label: 'Codes', value: 'codes', },
    { label: 'Results', value: 'results', },
  ]
}>

<TabItem value="codes">

```python showLineNumbers title="sync_by_web_services.py"
import multiprocessing
import flask
from syncstream.host import LineHostMirror, LineHostBuffer


def f(address):
    buffer = LineHostMirror(address=address, timeout=5)
    with buffer:
        print('example')
    buffer.send_eof()


app = flask.Flask(__name__)
hbuf = LineHostBuffer('/sync-stream', maxlen=10)
hbuf.serve(app)


@app.route('/test', methods=['GET'])
def another_service():
    address = 'http://localhost:5000/sync-stream'
    with multiprocessing.Pool(4) as p:
        p.map(f, tuple(address for _ in range(4)))
    hbuf_items = hbuf.read()
    return {'message': 'success', 'items': hbuf_items}, 200


if __name__ == '__main__':
    app.run(host='localhost', port=5000)  # Run the Flask service.
```

</TabItem>

<TabItem value="results">

After the server is launched, use the following address to get the results:

```html
http://localhost:5000/test
```

The response should be

```json
{"items": ["example", "example", "example", "example"], "message": "success"}
```

</TabItem>
</Tabs>

[link-flask]: https://flask.palletsprojects.com/en/stable/api/#flask.Flask
[link-deque-maxlen]: https://docs.python.org/3/library/collections.html#collections.deque.maxlen
