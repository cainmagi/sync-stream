---
id: LineHostBuffer
title: LineHostBuffer
sidebar_label: LineHostBuffer
slug: /apis/host/LineHostBuffer
description: 网络服务驱动的、以行为单元的缓存。
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import IconExternalLink from "@theme/Icon/ExternalLink";

import vsiCheckIcon from "@iconify-icons/codicon/check";

import APITopBar, {IconObjType} from "@site/src/components/APITopBar";
import InlineIcon from "@site/src/components/InlineIcon";

<APITopBar type="class" source="host.LineHostBuffer" />

```python
hbuf = LineHostBuffer(
    api_route: str = "/sync-stream",
    endpoint: str | None = None,
    maxlen: int = 2,
)
```

透过网络服务，实现并提供以行为单元的缓存。
The host service provider for the line-based buffer.

轮换缓存需要设置一个最大存储区长度。该缓存是基础缓存`LineBuffer`、针对多设备所设计的扩展版。其支持单服务端-多客户端模式，透过网络服务实现同步。要了解如何使用该缓存，可以查阅本页的[范例](#example)，或是[指南](../../guides/sync-host.mdx)。

## 别名 {#aliases}

该类可以按以下方式之一获取

```python
import syncstream


syncstream.LineHostBuffer
syncstream.host.LineHostBuffer
```

## 参数 {#arguments}

|    参数     |     类型      | 必选 | <center>说明</center>                                                                      |
| :---------: | :-----------: | :--: | :----------------------------------------------------------------------------------------- |
| `api_route` |     `str`     |      | API的路由路径。                                                                            |
| `endpoint`  | `str \| None` |      | API的endpoint名称。若设为`None`，则会从`api_route`推断endpoint名称。                       |
|  `maxlen`   |     `int`     |      | 所存储的最大行数。该值和[`deque.maxlen`<IconExternalLink/>][link-deque-maxlen]的含义相同。 |

## 方法 {#methods}

### <IconObjType type="method"/> `close` {#-close}

```python
hbuf.close(exc: BaseException | None = None)
```

关闭 IO。该方法只会生效一次。第二次调用则无任何效果。

---

### <IconObjType type="method"/> `read_serialized` {#-read_serialized}

```python
lines: tuple[str | SerializedMessage, ...] = hbuf.read_serialized(size: int | None = None)
```

读取信息（序列化）。

和`read(...)`的功能相同。不过，该方法返回的所有数据都是已经序列化过、可以和JSON兼容的数据。

该方法用来提供查询服务。

#### 输入 {#requires}

|  参数  |     类型      | 必选 | <center>说明</center>                                                        |
| :----: | :-----------: | :--: | :--------------------------------------------------------------------------- |
| `size` | `int \| None` |      | 若设为`None`，则会返回整个存储区。若设为一个整数，则会返回最后`size`条信息。 |

#### 输出 {#returns}

|  参数   |                  类型                  | <center>说明</center>                              |
| :-----: | :------------------------------------: | :------------------------------------------------- |
| `lines` | `tuple[str \| SerializedMessage, ...]` | 所获取的多项记录信息。结果按照先入先出的顺序排序。 |

---

### <IconObjType type="method"/> `serve` {#-serve}

```python
hbuf.serve(api: flask.Flask)
```

向Flask应用载入服务。

#### 输入 {#requires-1}

| 参数  |                      类型                      |               必选                | <center>说明</center>                                                          |
| :---: | :--------------------------------------------: | :-------------------------------: | :----------------------------------------------------------------------------- |
| `api` | [`flask.Flask`<IconExternalLink/>][link-flask] | <InlineIcon icon={vsiCheckIcon}/> | `Flask`对象。所有与该`LineHostBuffer`关联的网络服务、都会注册到`Flask`对象上。 |

---

### <IconObjType type="method"/> `stop_all_mirrors` {#-stop_all_mirrors}

```python
flag: bool = hbuf.stop_all_mirrors()
```

向所有的mirror发送中断信号。

该操作用于安全中断进程。它并不能保证进程会立刻结束。针对每个mirror，在每次要写信息的时候，检查中断信号。

若用户打算使用该方法，请确保在进程中捕获了`StopIteration`。该异常不会回送到缓存中。

#### 输出 {#returns-1}

|  参数  |  类型  | <center>说明</center>                                                                 |
| :----: | :----: | :------------------------------------------------------------------------------------ |
| `flag` | `bool` | 若中断成功，返回`True`。若中断遭到了拒绝，返回`False`。若服务端有任何异常，抛出错误。 |

---

### <IconObjType type="method"/> `reset_states` {#-reset_states}

```python
flag: bool = hbuf.reset_states()
```

重置缓存的状态。

若需要复用缓存，则应当调用该方法。

#### 输出 {#returns-2}

|  参数  |  类型  | <center>说明</center>                                                                 |
| :----: | :----: | :------------------------------------------------------------------------------------ |
| `flag` | `bool` | 若重置成功，返回`True`。若重置遭到了拒绝，返回`False`。若服务端有任何异常，抛出错误。 |

## 运算符 {#operators}

### <IconObjType type="op"/> `__len__`

```python
n_buffer_items: int = len(hbuf)
```

缓存中的行/条目数。

## 服务 {#services}

向Flask应用注册本实例后，则会启用以下服务，其中**加粗**的参数是必需的。

### <IconObjType type="service"/> `<api_route>` {#-api_route}

基础API。使用它们来维护用来保存各条信息的存储区域。

|  方法  | <center>输入</center>                                                                                                                                                       | <center>响应</center>                                                                                           | <center>描述</center>                                                                                                                  |
| :----: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------- |
|  GET   | <ul><li>`n`: 所要读取的信息条数。若不设置，返回整个存储区。</li></ul>                                                                                                       | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li><li>`data`: 返回信息构成的列表。</li></ul> | 获取多条信息。与[`LineBuffer.read()`](../mproc/LineBuffer.mdx#-read)相若。                                                             |
|  POST  | <ul><li>**`type`**: 信息的类型。可以是`str`，`error`，`warning`，或`close`。</li><li>`data`: 从[`LineHostMirror`](../host/LineHostMirror.mdx)获取的信息数据字典。</li></ul> | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li></ul>                                      | 将来自远端的的数据写入存储。用户不应当直接使用该方法，这是因为该方法是为了和[`LineHostMirror`](../host/LineHostMirror.mdx)联动设计的。 |
| DELETE | <center>-</center>                                                                                                                                                          | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li></ul>                                      | 清理存储区，但该方法不会重置缓存的状态。                                                                                               |

---

### <IconObjType type="service"/> `<api_route>-state` {#-api_route-state}

用来维护缓存状态的API。

|  方法  | <center>输入</center>                                                                 | <center>响应</center>                                                                                     | <center>描述</center>    |
| :----: | :------------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------- | :----------------------- |
|  GET   | <ul><li>**`state`**: 要读取的状态名称。</li></ul>                                     | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li><li>`data`: 所需的状态值。</li></ul> | 获取某个特定的状态值。   |
|  POST  | <ul><li>**`state`**: 要写入的状态名称。</li><li>`value`: 用来修改状态的值。</li></ul> | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li></ul>                                | 修改某个特定的状态值。   |
| DELETE | <center>-</center>                                                                    | <ul><li>`message`: 文字响应。若该结果有效，其值应当为`success`。</li></ul>                                | 将全部状态重置为默认值。 |

不同的客户端可以共享相同的状态。每次客户端和服务端互动时，客户端会使用`GET`方法来更新其状态。某些状态可以用来控制客户端的行为。例如，发送一个带有`state=closed`且`value=true`的`POST`，和调用[`LineProcBuffer.stop_all_mirrors()`](../mproc/LineProcBuffer.mdx#-stop_all_mirrors)具有相同的意义。

## 范例 {#example}

### <IconObjType type="term"/> 在网络服务之间同步信息 {#-synchronize-messages-by-web-services}

<Tabs
  defaultValue="codes"
  values={[
    { label: '代码', value: 'codes', },
    { label: '结果', value: 'results', },
  ]
}>

<TabItem value="codes">

```python showLineNumbers title="sync_by_web_services.py"
import multiprocessing
import flask
from syncstream.host import LineHostMirror, LineHostBuffer


def f(address):
    with LineHostMirror(address=address, timeout=5):
        print('example')


app = flask.Flask(__name__)
hbuf = LineHostBuffer('/sync-stream', maxlen=10)
hbuf.serve(app)


@app.route('/test', methods=['GET'])
def another_service():
    address = 'http://localhost:5000/sync-stream'
    with multiprocessing.Pool(4) as p:
        p.map(f, tuple(address for _ in range(4)))
    hbuf_items = hbuf.read()
    return {'message': 'success', 'items': hbuf_items}, 200


if __name__ == '__main__':
    app.run(host='localhost', port=5000)  # 运行Flask服务。
```

</TabItem>

<TabItem value="results">

服务器启动后，使用如下地址获取结果：

```html
http://localhost:5000/test
```

响应为

```json
{"items": ["example", "example", "example", "example"], "message": "success"}
```

</TabItem>
</Tabs>

[link-flask]: https://flask.palletsprojects.com/en/stable/api/#flask.Flask
[link-deque-maxlen]: https://docs.python.org/zh-cn/3/library/collections.html#collections.deque.maxlen
